<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sound Safari Game</title>
  <!-- Google Fonts: Quicksand for a phonics-friendly, single-storey 'a' and clear 'l' -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f0f8ff;
      --primary-color: #333;
      --secondary-color: #555;
      --button-bg: #fff0d5;
      --button-hover-bg: #ffe4b5;
      --button-selected-bg: #b6d7a8;
      --correct-bg: #93c47d;
      --correct-hover-bg: #6aa84f;
      --home-button-bg: #add8e6;
      --home-button-hover-bg: #87ceeb;
      --build-button-bg: #ffe0b2;
      --build-button-hover-bg: #ffd18c;
      --border-color: #ccc;
      --border-width: 3px;
      --border-radius: 15px;
      --main-font: 'Quicksand', sans-serif; /* Updated to Quicksand */
    }

    body {
      font-family: var(--main-font);
      background-color: var(--bg-color);
      color: var(--primary-color);
      text-align: center;
      padding: 30px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    h1 {
      font-size: clamp(2em, 8vw, 3em);
      margin-bottom: 20px;
    }
    
    button {
      font-family: inherit;
      border: none;
      background: none;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }

    button:active {
        transform: scale(0.95);
    }

    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .home-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: var(--home-button-bg);
        color: var(--primary-color);
        font-size: clamp(1em, 3vw, 1.2em);
        padding: 10px 20px;
        border-radius: var(--border-radius);
        border: 2px solid var(--border-color);
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }

    .home-button:hover {
        background-color: var(--home-button-hover-bg);
    }

    .menu-button {
      background: var(--button-bg);
      border: var(--border-width) solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin: 15px;
      font-size: clamp(1em, 4vw, 1.5em);
      box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
    }

    .menu-button:hover {
      background: var(--button-hover-bg);
    }
    
    /* Style for the Build a Word button */
    #buildWordBtn {
        background-color: var(--build-button-bg);
    }
    #buildWordBtn:hover {
        background-color: var(--build-button-hover-bg);
    }

    /* Style for Flashcard Pack Selection buttons */
    #flashcardPackSelection .menu-button {
        background-color: var(--button-bg);
        border: var(--border-width) solid var(--border-color);
        margin: 10px;
        padding: 15px;
        font-size: clamp(1em, 3.5vw, 1.3em);
    }
    #flashcardPackSelection .menu-button:hover {
        background-color: var(--button-hover-bg);
    }


    .score {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    .stars {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      height: 2em;
    }

    .star {
      font-size: 2em;
      margin: 0 5px;
    }

    #prompt {
      font-size: clamp(1em, 4vw, 1.3em); /* Made smaller */
      margin-bottom: 20px;
      min-height: 1.2em;
    }

    .blend-box {
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
      max-width: 900px;
      width: 100%;
    }
    
    .blend-box.horizontal {
        flex-direction: row;
    }

    /* Styles for flashcard in Learn Mode */
    #flashcardContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 300px;
        min-height: 200px; /* Maintain height to prevent jumping */
        margin: 20px auto;
        background-color: var(--button-bg);
        border: var(--border-width) solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
        opacity: 1; /* Default state */
        transition: opacity 0.3s ease-in-out; /* Smooth transition for opacity */
        padding-bottom: 10px; /* Add padding for description */
    }

    #flashcardContainer.fade-out {
        opacity: 0;
    }

    #flashcardLetter {
        font-size: clamp(4em, 15vw, 8em);
        font-weight: bold;
        color: var(--primary-color);
        margin: 0;
        padding: 20px;
        transition: color 0.3s ease-in-out; /* Smooth color transition for reveal */
    }
    
    #flashcardLetter.hidden-content { /* Renamed for clarity */
        color: transparent; /* Hide the letter but keep its space */
    }

    #flashcardPhonemeDescription {
        font-size: clamp(0.9em, 2.5vw, 1.1em);
        color: var(--secondary-color);
        margin-top: -10px; /* Pull it slightly closer to the letter */
        margin-bottom: 10px;
        min-height: 1.2em; /* Prevent layout shift if no text */
        text-align: center;
        padding: 0 10px;
    }


    .flashcard-nav-buttons {
        display: flex;
        justify-content: center;
        width: 100%;
        margin-top: 15px;
        padding: 0 10px;
    }

    .flashcard-nav-buttons button {
        background-color: var(--home-button-bg);
        padding: 10px 20px;
        border-radius: var(--border-radius);
        border: 2px solid var(--border-color);
        font-size: 1.2em;
        min-width: 100px;
    }
    .flashcard-nav-buttons button:hover {
        background-color: var(--home-button-hover-bg);
    }
    
    /* Buttons for flashcard self-assessment */
    .flashcard-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
    }
    .flashcard-actions button {
        background-color: var(--correct-bg);
        color: white;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        font-size: 1.1em;
        min-width: 120px;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    .flashcard-actions button:hover {
        opacity: 0.9;
    }

    #flashcardProgress {
        margin-top: 10px;
        font-size: 1em;
        color: var(--secondary-color);
    }

    /* Hide individual letter set containers in flashcard mode */
    .letter-set-container {
        display: none; 
    }

    .letter-set-title {
      font-size: clamp(1.2em, 4vw, 1.5em);
      color: var(--secondary-color);
      margin-bottom: 15px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .letters-wrapper {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }

    .letter {
      background: var(--button-bg);
      border: var(--border-width) solid var(--border-color);
      border-radius: var(--border-radius);
      width: clamp(70px, 18vw, 90px); /* Made larger */
      height: clamp(70px, 18vw, 90px); /* Made larger */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(3em, 10vw, 4em); /* Increased font size */
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease-in-out; /* For click feedback */
    }
    
    .letter.selected {
      background-color: var(--button-selected-bg);
      border-color: #79ac65;
      box-shadow: inset 1px 1px 3px rgba(0,0,0,0.3);
    }
    
    /* New styles for letter click feedback */
    .letter.blended-active {
        background-color: var(--home-button-hover-bg); /* Highlight color on click */
        transform: scale(1.05); /* Slightly pop out */
        transition: all 0.1s ease-out;
    }

    .letter:hover,
    .word-choice:hover {
      background: var(--button-hover-bg);
    }

    .blended-word {
      font-size: clamp(4em, 14vw, 6em); /* Increased font size */
      font-weight: bold;
      margin: 20px 0;
      color: var(--primary-color);
      min-height: 1.5em;
    }

    .choices {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      max-width: 900px;
      width: 100%;
    }

    .word-choice {
      background: var(--button-bg);
      border: var(--border-width) solid var(--border-color);
      border-radius: var(--border-radius);
      padding: clamp(15px, 5vw, 30px);
      font-size: clamp(1.5em, 5vw, 2em);
      flex: 1 1 30%;
      min-width: 150px;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out; /* For feedback colors */
    }

    /* New styles for word choice feedback */
    .word-choice.correct-feedback {
        background-color: var(--correct-bg);
        border-color: #6aa84f;
        color: white;
    }

    .word-choice.incorrect-feedback {
        background-color: #e06666; /* Red */
        border-color: #a63f3f;
        color: white;
    }

    .reset-button {
      background: var(--button-bg);
      border: var(--border-width) solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 15px 25px;
      font-size: clamp(1em, 4vw, 1.5em);
      margin-bottom: 20px; /* Keep existing margin */
      margin-top: 40px; /* Increased margin to top for more space */
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }

    .reset-button:hover {
      background: var(--button-hover-bg);
    }

    .feedback {
      font-size: clamp(1.5em, 6vw, 2em);
      margin-top: 30px;
      font-weight: bold;
      min-height: 1.5em;
    }

    .emoji {
      font-size: 1.5em;
      margin-left: 0.2em;
    }

    .play-again {
      background: var(--correct-bg);
      color: white;
      border-radius: var(--border-radius);
      padding: 20px 30px;
      font-size: clamp(1em, 4vw, 1.2em);
      margin-top: 30px;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
    }

    .play-again:hover {
      background: var(--correct-hover-bg);
    }
    
    .hidden {
        display: none !important;
    }

    /* Styles for Build a Word mode */
    #buildWordDisplay {
        font-size: clamp(2.5em, 10vw, 4em);
        font-weight: bold;
        color: var(--primary-color);
        display: flex;
        justify-content: center;
        gap: 10px; /* Increased gap between letters in built word */
        border-bottom: 2px solid var(--secondary-color);
        padding-bottom: 10px;
        margin: 20px 0 30px 0; /* Combined margin properties */
        min-height: 1.5em;
    }

    /* New styles for the build word target flashcard */
    #buildWordTargetFlashcard {
        display: flex;
        flex-direction: column; /* Allow text description below word */
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 300px; /* Same as flashcardContainer */
        min-height: 100px; /* Adjusted height for words */
        margin: 15px auto;
        background-color: var(--button-bg);
        border: var(--border-width) solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
        font-size: clamp(2.5em, 8vw, 4em); /* Size for target word */
        font-weight: bold;
        color: var(--primary-color);
        opacity: 0; /* Start hidden for fade-in */
        transition: opacity 0.5s ease-in-out;
    }
    #buildWordTargetFlashcard.fade-in {
        opacity: 1;
    }


    #letterPool {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
    }

    #letterPool .letter { /* Re-use existing .letter style for pool */
        background-color: var(--build-button-bg);
    }
    #letterPool .letter:hover {
        background-color: var(--build-button-hover-bg);
    }
    #letterPool .letter.selected { /* This class is now used for letters moved to userBuiltWord */
        background-color: var(--button-selected-bg);
        border-color: #79ac65;
    }

    .build-actions {
        margin-top: 30px;
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
    }
    .build-actions button {
        background-color: var(--home-button-bg);
        padding: 15px 30px;
        border-radius: var(--border-radius);
        border: 2px solid var(--border-color);
        font-size: 1.2em;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    .build-actions button:hover {
        background-color: var(--home-button-hover-bg);
    }

  </style>
</head>
<body>
  <button id="homeBtn" class="home-button hidden">🏠 Home</button>

  <h1>🦁 Sound Safari</h1>
  <div id="menu">
    <button class="menu-button" id="learnLettersBtn">🧩 Practice Phase 2 Sounds</button>
    <button class="menu-button" id="blendWordsBtn">🔤 Blend SATPIN Words</button>
    <button class="menu-button" id="buildWordBtn">🛠️ Build a Word</button>
    <button class="menu-button" id="trickyWordsBtn">🤯 Tricky Words</button>
  </div>

  <div id="gameArea" class="hidden">
    <div class="score" id="score">Score: 0</div>
    <div class="stars" id="stars"></div>
    <h2 id="prompt"></h2>

    <div id="flashcardPackSelection" class="hidden">
      <p id="packSelectionIntroText">Choose a Set:</p>
      <div id="packButtons" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
        </div>
      <button class="menu-button" id="backToMainMenuBtn">Back to Main Menu</button>
    </div>

    <div id="flashcardContainer" class="hidden" data-mastered-unique-letters="">
        <p id="flashcardLetter"></p>
        <p id="flashcardPhonemeDescription"></p>
        <div id="flashcardActions" class="flashcard-actions">
            <button id="gotItBtn">✅ Got It!</button>
            <button id="needPracticeBtn" class="need-practice">❌ Need Practice</button>
        </div>
        <div class="flashcard-nav-buttons hidden">
            </div>
        <div id="flashcardProgress"></div>
    </div>

    <div class="blend-box" id="blendBox"></div>
    <div class="blended-word" id="blendText"></div>

    <div id="buildWordTargetFlashcard" class="hidden"></div>

    <div id="buildWordDisplay" class="hidden"></div>
    <div id="letterPool" class="hidden"></div>
    <div class="build-actions hidden">
        <button id="clearBuildBtn">Clear</button>
        <button id="checkBuildBtn">Check</button>
    </div>

    <div class="choices" id="wordChoices"></div>
    <button class="reset-button" id="resetBtn">🔄 Reset</button>
    <div class="feedback" id="feedback"></div>
  </div>

  <div id="gameComplete" class="hidden">
    <h2>🏆 Well done!</h2>
    <p id="finalMessage"></p>
    <button class="play-again" id="playAgainBtn">Play Again</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- DOM ELEMENTS ---
      const elements = {
        menu: document.getElementById('menu'),
        gameArea: document.getElementById('gameArea'),
        homeBtn: document.getElementById('homeBtn'),
        learnLettersBtn: document.getElementById('learnLettersBtn'),
        blendWordsBtn: document.getElementById('blendWordsBtn'),
        buildWordBtn: document.getElementById('buildWordBtn'),
        trickyWordsBtn: document.getElementById('trickyWordsBtn'), 
        scoreDisplay: document.getElementById('score'),
        starsDisplay: document.getElementById('stars'),
        prompt: document.getElementById('prompt'),
        
        flashcardPackSelection: document.getElementById('flashcardPackSelection'),
        packSelectionIntroText: document.getElementById('packSelectionIntroText'), 
        packButtons: document.getElementById('packButtons'),
        backToMainMenuBtn: document.getElementById('backToMainMenuBtn'),

        flashcardContainer: document.getElementById('flashcardContainer'),
        flashcardLetter: document.getElementById('flashcardLetter'),
        flashcardPhonemeDescription: document.getElementById('flashcardPhonemeDescription'),
        flashcardActions: document.getElementById('flashcardActions'),
        gotItBtn: document.getElementById('gotItBtn'),
        needPracticeBtn: document.getElementById('needPracticeBtn'),

        flashcardProgress: document.getElementById('flashcardProgress'),

        blendBox: document.getElementById('blendBox'),
        blendText: document.getElementById('blendText'),

        buildWordTargetFlashcard: document.getElementById('buildWordTargetFlashcard'), 

        buildWordDisplay: document.getElementById('buildWordDisplay'),
        letterPool: document.getElementById('letterPool'),
        clearBuildBtn: document.getElementById('clearBuildBtn'),
        checkBuildBtn: document.getElementById('checkBuildBtn'),
        
        wordChoices: document.getElementById('wordChoices'),
        resetBtn: document.getElementById('resetBtn'),
        feedback: document.getElementById('feedback'),
        gameComplete: document.getElementById('gameComplete'),
        finalMessage: document.getElementById('finalMessage'),
        playAgainBtn: document.getElementById('playAgainBtn'),
      };

      // --- GAME DATA & STATE ---
      const letterSets = {
        'Set 1': ['s', 'a', 't', 'p'],
        'Set 2': ['i', 'n', 'm', 'd'],
        'Set 3': ['g', 'o', 'c', 'k'],
        'Set 4': ['ck', 'e', 'u', 'r'],
        'Set 5': ['h', 'b', 'f', 'ff', 'l', 'll', 'ss']
      };
      const allPhase2Letters = Object.values(letterSets).flat();
      const masterBuildLettersPool = [...letterSets['Set 1'], ...letterSets['Set 2']]; // For build a word

      // Tricky Word Sets
      const trickyWordSets = {
          'Set 1 – Foundation Words': {
              words: ['I', 'the', 'to', 'no', 'go'],
              description: 'Short, very frequent words that appear in almost every beginner book.'
          },
          'Set 2 – Early Sentence Builders': {
              words: ['into', 'he', 'she', 'we', 'me'],
              description: 'Helps children build simple subject-verb sentences like “He is big.”'
          },
          'Set 3 – Identity and Action Words': {
              words: ['be', 'was', 'my', 'you', 'they'],
              description: 'Introduces trickier spelling patterns and supports early storytelling.'
          },
          'Set 4 – Describing and Referring Words': {
              words: ['her', 'all', 'are', 'your', 'said'],
              description: 'Introduces trickier spelling patterns and supports early storytelling.'
          }
      };


      // Phoneme descriptions for visual/textual guidance
      const phonemeDescriptions = {
        's': 'Snake sound: teeth close, tongue behind.',
        'a': 'Open mouth, "ah" sound like in apple.',
        't': 'Tap tongue behind teeth, quick "tuh" sound.',
        'p': 'Pop lips together, quick "puh" sound.',
        'i': 'Small smile, "ih" sound like in ink.',
        'n': 'Tongue tip behind teeth, nose hums.',
        'm': 'Lips together, mouth closed, hum.',
        'd': 'Tap tongue behind teeth, quick "duh" sound.',
        'g': 'Back of tongue up, "guh" sound.',
        'o': 'Round mouth, short "oh" sound.',
        'c': 'Back of tongue up, quick "kuh" sound.',
        'k': 'Back of tongue up, quick "kuh" sound.',
        'ck': 'Same as "k", two letters one sound.',
        'e': 'Relaxed mouth, short "eh" sound.',
        'u': 'Short "uh" sound, like up.',
        'r': 'Tongue curls back, "rrr" sound.',
        'h': 'Quiet breath out of mouth.',
        'b': 'Lips together, puff of air, "buh" sound.',
        'f': 'Top teeth on lower lip, blow air.',
        'ff': 'Same as "f", two letters one sound.',
        'l': 'Tongue tip behind top teeth, "llll" sound.',
        'll': 'Same as "l", two letters one sound.',
        'ss': 'Same as "s", two letters one sound.'
      };

      const satpinWordsList = [
        { word: 'sat', emoji: '🪑' }, { word: 'pin', emoji: '📌' }, { word: 'pat', emoji: '👏' }, { word: 'tap', emoji: '🚰' },
        { word: 'nap', emoji: '😴' }, { word: 'sip', emoji: '🥤' }, { word: 'tip', emoji: '💡' }, { word: 'tan', emoji: '🌞' },
        { word: 'pit', emoji: '🕳️' }, { word: 'pan', emoji: '🍳' }
      ];

      const gameState = {
        score: 0,
        stars: 0,
        blended: '',
        correctWord: '',
        correctEmoji: '',
        currentWords: [], 
        mode: '', 

        currentFlashcardIndex: 0, 
        currentFlashcardLetters: [], 
        currentFlashcardSetName: '', 
        flashcardMasterList: [],
        flashcardsCompletedCount: 0,
        packSelectionType: '', 
        currentFlashcardSetDescription: '', // Stores the description for the current tricky word set
        
        targetBuildWord: '',
        userBuiltWord: [], 
        buildLettersPool: [], 
        availableBuildWords: [], 
      };

      // --- UTILITY FUNCTIONS ---
      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
      }

      // Function to enable/disable blending-related controls
      function toggleBlendingControls(enable) {
          const letterButtons = elements.blendBox.querySelectorAll('.letter');
          letterButtons.forEach(button => {
              button.disabled = !enable;
          });
          const wordChoiceButtons = elements.wordChoices.querySelectorAll('.word-choice');
          wordChoiceButtons.forEach(button => {
              button.disabled = !enable;
          });
      }

      // Function to update the display for "Build a Word" mode
      function updateBuildWordDisplay() {
          elements.buildWordDisplay.textContent = gameState.userBuiltWord.join('');
          elements.feedback.textContent = ''; 
      }

      // --- EVENT LISTENERS ---
      elements.learnLettersBtn.addEventListener('click', () => showFlashcardPackSelection('letters'));
      elements.blendWordsBtn.addEventListener('click', () => startGame('words'));
      elements.buildWordBtn.addEventListener('click', () => startGame('build'));
      elements.trickyWordsBtn.addEventListener('click', () => showFlashcardPackSelection('trickyWords')); 
      elements.homeBtn.addEventListener('click', goHome); 

      elements.resetBtn.addEventListener('click', () => {
        if (gameState.mode === 'words') {
          gameState.blended = '';
          elements.blendText.textContent = gameState.blended.split('').join(' ');
          const letterButtons = elements.blendBox.querySelectorAll('.letter');
          letterButtons.forEach(button => {
              button.classList.remove('blended-active');
              button.disabled = false; 
          });
          toggleBlendingControls(true); 
        } else if (gameState.mode === 'build') {
          // In build mode, reset means get a new word
          setupBuildMode(); 
        }
      });

      elements.gotItBtn.addEventListener('click', () => processFlashcardResponseAndAdvance('gotIt'));
      elements.needPracticeBtn.addEventListener('click', () => processFlashcardResponseAndAdvance('needPractice'));

      elements.backToMainMenuBtn.addEventListener('click', goHome);

      elements.clearBuildBtn.addEventListener('click', clearBuild);
      elements.checkBuildBtn.addEventListener('click', checkBuildWord);

      // --- NAVIGATION FUNCTIONS ---
      function goHome() {
        elements.gameArea.classList.add('hidden');
        elements.gameComplete.classList.add('hidden');
        elements.flashcardPackSelection.classList.add('hidden');
        elements.homeBtn.classList.add('hidden');
        elements.menu.classList.remove('hidden');
        clearBoard();
      }

      // --- GAME LOGIC ---
      function startGame(mode) {
        gameState.mode = mode;
        gameState.score = 0; 
        gameState.stars = 0; 
        if (mode === 'words') {
            gameState.currentWords = [...satpinWordsList]; 
        }
        gameState.currentFlashcardIndex = 0;
        gameState.flashcardsCompletedCount = 0;
        gameState.packSelectionType = ''; 
        gameState.currentFlashcardSetDescription = ''; // Clear description on game start

        elements.menu.classList.add('hidden');
        elements.gameComplete.classList.add('hidden');
        elements.homeBtn.classList.remove('hidden');
        elements.gameArea.classList.remove('hidden');
        
        clearBoard();
        updateScore(); 
        updateStars(); 
        hideAllGameSpecificElements();

        if (mode === 'words') {
          setupBlendMode();
        } else if (mode === 'build') {
            setupBuildMode();
        }
      }

      function updateScore() {
        if (gameState.mode === 'words') {
            elements.scoreDisplay.textContent = `Score: ${gameState.score}`;
            elements.scoreDisplay.classList.remove('hidden');
        } else {
            elements.scoreDisplay.classList.add('hidden'); 
        }
      }

      function updateStars() {
        if (gameState.mode === 'words') {
            elements.starsDisplay.innerHTML = Array(gameState.stars).fill('⭐').map(s => `<span class="star">${s}</span>`).join('');
            elements.starsDisplay.classList.remove('hidden');
        } else {
            elements.starsDisplay.innerHTML = ''; 
            elements.starsDisplay.classList.add('hidden');
        }
      }
      
      function hideAllGameSpecificElements() {
          elements.flashcardPackSelection.classList.add('hidden');
          elements.flashcardContainer.classList.add('hidden');
          elements.flashcardActions.classList.add('hidden');
          elements.flashcardProgress.classList.add('hidden');
          elements.flashcardPhonemeDescription.textContent = ''; 


          elements.blendBox.innerHTML = '';
          elements.blendBox.classList.remove('horizontal');
          elements.blendText.textContent = '';
          elements.blendText.classList.add('hidden');

          elements.buildWordTargetFlashcard.classList.add('hidden'); 
          elements.buildWordTargetFlashcard.classList.remove('fade-in'); 
          elements.buildWordTargetFlashcard.textContent = '';


          elements.buildWordDisplay.innerHTML = '';
          elements.buildWordDisplay.classList.add('hidden');
          elements.letterPool.innerHTML = '';
          elements.letterPool.classList.add('hidden');
          elements.clearBuildBtn.classList.add('hidden');
          elements.checkBuildBtn.classList.add('hidden');
          elements.wordChoices.classList.add('hidden');
          elements.resetBtn.classList.add('hidden');
          
          elements.scoreDisplay.classList.add('hidden'); 
          elements.starsDisplay.classList.add('hidden');
      }

      function clearBoard() {
          elements.feedback.textContent = '';
          elements.blendText.textContent = '';
          elements.blendBox.innerHTML = '';
          elements.wordChoices.innerHTML = '';
          gameState.blended = '';
          
          gameState.userBuiltWord = [];
          elements.buildWordDisplay.textContent = ''; 
          elements.letterPool.innerHTML = '';
          elements.feedback.textContent = '';
          
          elements.buildWordTargetFlashcard.classList.add('hidden'); 
          elements.buildWordTargetFlashcard.classList.remove('fade-in');
          elements.buildWordTargetFlashcard.textContent = '';

          elements.flashcardPhonemeDescription.textContent = ''; 
      }

      // Modified to handle both letter and tricky word pack selections
      function showFlashcardPackSelection(packType) {
          gameState.mode = 'flashcards'; 
          gameState.packSelectionType = packType; 

          elements.menu.classList.add('hidden');
          elements.gameComplete.classList.add('hidden');
          elements.homeBtn.classList.remove('hidden');
          elements.gameArea.classList.remove('hidden');

          hideAllGameSpecificElements();
          elements.flashcardPackSelection.classList.remove('hidden');
          
          elements.packSelectionIntroText.textContent = `Choose a ${packType === 'letters' ? 'Phase 2 Sound' : 'Tricky Word'} Set:`;

          elements.packButtons.innerHTML = '';
          const sets = packType === 'letters' ? letterSets : trickyWordSets;
          
          let allItems = [];
          let allItemsName = '';
          if (packType === 'letters') {
              allItems = [...allPhase2Letters];
              allItemsName = 'All Sounds';
          } else { 
              allItems = Object.values(trickyWordSets).flatMap(set => set.words);
              allItemsName = 'All Tricky Words';
          }

          for (const setName in sets) {
              const setContent = sets[setName];
              const displayItems = Array.isArray(setContent) ? setContent : setContent.words;
              const button = document.createElement('button');
              button.className = 'menu-button';
              button.textContent = `${setName}: ${displayItems.join(', ')}`;
              button.addEventListener('click', () => startFlashcardPack(setName, packType)); 
              elements.packButtons.appendChild(button);
          }

          const allButton = document.createElement('button');
          allButton.className = 'menu-button';
          allButton.textContent = allItemsName;
          allButton.addEventListener('click', () => startFlashcardPack(allItemsName, packType));
          elements.packButtons.appendChild(allButton);
      }


      function startFlashcardPack(packName, packType) {
          elements.flashcardPackSelection.classList.add('hidden');
          elements.flashcardContainer.classList.remove('hidden');
          elements.flashcardActions.classList.remove('hidden');
          elements.flashcardProgress.classList.remove('hidden');

          let itemsForThisPack;
          gameState.currentFlashcardSetDescription = ''; 

          if (packType === 'letters') {
              if (packName === 'All Sounds') {
                  itemsForThisPack = [...allPhase2Letters];
              } else {
                  itemsForThisPack = [...letterSets[packName]];
              }
              elements.prompt.textContent = `What sound is this?`;
          } else { 
              if (packName === 'All Tricky Words') {
                  itemsForThisPack = Object.values(trickyWordSets).flatMap(set => set.words);
                  elements.prompt.textContent = `What is this tricky word?`;
              } else {
                  itemsForThisPack = [...trickyWordSets[packName].words];
                  elements.prompt.textContent = `What is this tricky word?`;
                  gameState.currentFlashcardSetDescription = trickyWordSets[packName].description;
              }
          }
          
          gameState.flashcardMasterList = itemsForThisPack;
          gameState.currentFlashcardLetters = shuffleArray([...itemsForThisPack]);
          gameState.currentFlashcardIndex = 0;
          gameState.currentFlashcardSetName = packName;
          gameState.flashcardsCompletedCount = 0;
          elements.flashcardContainer.dataset.masteredUniqueLetters = ''; 

          displayFlashcard();
      }

      function displayFlashcard() {
          if (gameState.currentFlashcardLetters.length === 0) {
              elements.prompt.textContent = `Finished! You've mastered all ${gameState.packSelectionType === 'letters' ? 'sounds' : 'tricky words'} in the ${gameState.currentFlashcardSetName} pack!`;
              elements.flashcardContainer.classList.add('hidden');
              
              elements.gameComplete.classList.remove('hidden');
              elements.finalMessage.textContent = `You've mastered all ${gameState.packSelectionType === 'letters' ? 'sounds' : 'tricky words'} in the ${gameState.currentFlashcardSetName} pack!`;
              
              elements.playAgainBtn.textContent = `Play This Pack Again`;
              elements.playAgainBtn.onclick = () => {
                let existingChooseAnother = elements.gameComplete.querySelector('.choose-another-pack-btn');
                if (existingChooseAnother) { existingChooseAnother.remove(); }
                startFlashcardPack(gameState.currentFlashcardSetName, gameState.packSelectionType);
              };
              
              let existingChooseAnother = elements.gameComplete.querySelector('.choose-another-pack-btn');
              if (existingChooseAnother) {
                  existingChooseAnother.remove();
              }
              const chooseAnotherPackBtn = document.createElement('button');
              chooseAnotherPackBtn.className = 'play-again choose-another-pack-btn';
              chooseAnotherPackBtn.textContent = 'Choose Another Pack';
              chooseAnotherPackBtn.onclick = () => showFlashcardPackSelection(gameState.packSelectionType);
              elements.gameComplete.appendChild(chooseAnotherPackBtn); 

              return;
          }

          const currentItem = gameState.currentFlashcardLetters[gameState.currentFlashcardIndex];
          elements.flashcardLetter.textContent = currentItem;
          elements.flashcardLetter.classList.remove('hidden-content');
          
          if (gameState.packSelectionType === 'letters') {
              elements.flashcardPhonemeDescription.textContent = phonemeDescriptions[currentItem] || '';
          } else { 
              elements.flashcardPhonemeDescription.textContent = gameState.currentFlashcardSetDescription || 'Try to remember this word!';
          }

          elements.flashcardProgress.textContent = `Mastered: ${gameState.flashcardsCompletedCount} of ${gameState.flashcardMasterList.length}`;
      }

      function processFlashcardResponseAndAdvance(assessment) {
          elements.flashcardContainer.classList.add('fade-out');

          setTimeout(() => {
              const currentItem = gameState.currentFlashcardLetters[gameState.currentFlashcardIndex];

              if (assessment === 'gotIt') {
                  if (!elements.flashcardContainer.dataset.masteredUniqueLetters.includes(currentItem)) {
                      gameState.flashcardsCompletedCount++;
                      elements.flashcardContainer.dataset.masteredUniqueLetters += currentItem; 
                  }
                  gameState.currentFlashcardLetters.splice(gameState.currentFlashcardIndex, 1);
                  
                  if (gameState.currentFlashcardLetters.length > 0) {
                      if (gameState.currentFlashcardIndex >= gameState.currentFlashcardLetters.length) {
                          gameState.currentFlashcardIndex = 0; 
                      }
                  } else {
                      gameState.currentFlashcardIndex = 0;
                  }

              } else if (assessment === 'needPractice') {
                  gameState.currentFlashcardLetters.push(currentItem);
                  gameState.currentFlashcardIndex++;
                  if (gameState.currentFlashcardIndex >= gameState.currentFlashcardLetters.length) {
                      gameState.currentFlashcardIndex = 0; 
                  }
              }

              elements.flashcardContainer.classList.remove('fade-out');
              displayFlashcard();
          }, 300);
      }

      // --- BLEND WORDS MODE ---
      function setupBlendMode() {
        clearBoard();
        elements.prompt.innerHTML = 'Blend the sounds and click the correct word.<br>Collect 5 ⭐ to complete this activity!';
        updateScore(); 
        updateStars(); 
        elements.resetBtn.classList.remove('hidden');
        elements.wordChoices.classList.remove('hidden');
        elements.blendText.classList.remove('hidden');
        elements.blendBox.classList.add('horizontal');

        toggleBlendingControls(true); 

        if (gameState.currentWords.length === 0) {
          endBlendingGame(); 
          return;
        }

        const wordIndex = Math.floor(Math.random() * gameState.currentWords.length);
        const chosenWordObject = gameState.currentWords.splice(wordIndex, 1)[0];
        gameState.correctWord = chosenWordObject.word;
        gameState.correctEmoji = chosenWordObject.emoji;

        elements.blendBox.innerHTML = ''; 
        gameState.blended = '';
        elements.blendText.textContent = gameState.blended.split('').join(' ');

        gameState.correctWord.split('').forEach(l => {
          const letterButton = document.createElement('button');
          letterButton.className = 'letter';
          letterButton.textContent = l;
          letterButton.addEventListener('click', (event) => {
            gameState.blended += l;
            elements.blendText.textContent = gameState.blended.split('').join(' ');
            event.target.classList.add('blended-active');
            event.target.disabled = true; 
            setTimeout(() => {
                event.target.classList.remove('blended-active');
            }, 150);
          });
          elements.blendBox.appendChild(letterButton);
        });

        const distractors = satpinWordsList.filter(w => w.word !== gameState.correctWord);
        const shuffledDistractors = distractors.sort(() => 0.5 - Math.random());
        const options = [chosenWordObject, ...shuffledDistractors.slice(0, 2)];
        
        elements.wordChoices.innerHTML = '';

        options.sort(() => 0.5 - Math.random()).forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'word-choice';
          btn.innerHTML = `${opt.word} <span class="emoji">${opt.emoji}</span>`;
          btn.addEventListener('click', () => handleChoice(opt.word, btn));
          elements.wordChoices.appendChild(btn);
        });
      }
      
      function handleChoice(selection, chosenButton) {
        toggleBlendingControls(false); 

        if (selection === gameState.correctWord) {
          gameState.score++;
          if (gameState.score > 0 && gameState.score % 2 === 0) {
            gameState.stars++;
          }
          updateScore();
          updateStars();
          elements.feedback.textContent = `🎉 Correct! ${gameState.correctEmoji}`;
          chosenButton.classList.add('correct-feedback');
          
          if (gameState.stars >= 5) {
              endGame("You earned 5 stars!");
              return;
          }

          setTimeout(() => {
            chosenButton.classList.remove('correct-feedback');
            setupBlendMode();
          }, 1200);

        } else {
          elements.feedback.textContent = '❌ Try again!';
          chosenButton.classList.add('incorrect-feedback');
          setTimeout(() => {
            chosenButton.classList.remove('incorrect-feedback');
            toggleBlendingControls(true); 
            const letterButtons = elements.blendBox.querySelectorAll('.letter');
            letterButtons.forEach(button => {
                button.disabled = false; 
            });
          }, 800);
        }
      }

      function endBlendingGame() {
        elements.gameArea.classList.add('hidden');
        elements.gameComplete.classList.remove('hidden');
        elements.finalMessage.textContent = `You've blended all the SATPIN words!`;
        
        let existingChooseAnother = elements.gameComplete.querySelector('.choose-another-pack-btn');
        if (existingChooseAnother) {
            existingChooseAnother.remove();
        }

        elements.playAgainBtn.textContent = 'Play SATPIN Words Again';
        elements.playAgainBtn.onclick = () => startGame('words');

        const chooseAnotherGameBtn = document.createElement('button');
        chooseAnotherGameBtn.className = 'play-again choose-another-game-btn';
        chooseAnotherGameBtn.textContent = 'Choose Another Game';
        chooseAnotherGameBtn.onclick = () => goHome();
        elements.gameComplete.appendChild(chooseAnotherGameBtn);
      }


      // --- BUILD A WORD MODE ---
      function setupBuildMode() {
        clearBoard();
        elements.prompt.innerHTML = 'Use the letters to build a SATPIN word (from Set 1 & 2 sounds)!';
        
        updateScore(); 
        updateStars(); 

        elements.buildWordTargetFlashcard.classList.remove('hidden'); 
        elements.buildWordDisplay.classList.remove('hidden');
        elements.letterPool.classList.remove('hidden');
        elements.clearBuildBtn.classList.remove('hidden');
        elements.checkBuildBtn.classList.remove('hidden');
        elements.resetBtn.classList.remove('hidden'); 

        if (gameState.availableBuildWords.length === 0 || gameState.mode !== 'build') { 
            const filteredWords = satpinWordsList.filter(wordObj => {
                const wordLetters = wordObj.word.split('');
                const allowedLetters = [...letterSets['Set 1'], ...letterSets['Set 2']];
                
                const tempAllowed = [...allowedLetters];
                let possible = true;
                for (const char of wordLetters) {
                    const idx = tempAllowed.indexOf(char);
                    if (idx > -1) {
                        tempAllowed.splice(idx, 1); 
                    } else {
                        possible = false; 
                        break;
                    }
                }
                return possible;
            });
            gameState.availableBuildWords = shuffleArray([...filteredWords]);
            gameState.mode = 'build'; 
        }

        if (gameState.availableBuildWords.length === 0) {
            endBuildGame('You have built all the words from Set 1 & 2!');
            return;
        }

        const wordIndex = Math.floor(Math.random() * gameState.availableBuildWords.length);
        const chosenWordObject = gameState.availableBuildWords.splice(wordIndex, 1)[0];
        gameState.targetBuildWord = chosenWordObject.word;
        gameState.correctEmoji = chosenWordObject.emoji;
        
        elements.buildWordTargetFlashcard.textContent = gameState.targetBuildWord.toLowerCase(); 
        elements.buildWordTargetFlashcard.classList.remove('fade-in'); 
        void elements.buildWordTargetFlashcard.offsetWidth; 
        elements.buildWordTargetFlashcard.classList.add('fade-in'); 

        gameState.userBuiltWord = []; 
        gameState.buildLettersPool = shuffleArray([...masterBuildLettersPool]); 
        
        renderLetterPool();
        updateBuildWordDisplay();
      }

      function selectLetterForBuild(letter, buttonElement) {
          gameState.userBuiltWord.push(letter);
          updateBuildWordDisplay();

          buttonElement.disabled = true; 
          buttonElement.classList.add('selected'); 
          buttonElement.classList.add('blended-active'); 
          setTimeout(() => {
              buttonElement.classList.remove('blended-active');
          }, 150);
      }


      function renderLetterPool() {
        elements.letterPool.innerHTML = '';
        const currentPoolRender = [...masterBuildLettersPool]; 

        currentPoolRender.forEach((letter, index) => {
            const letterBtn = document.createElement('button');
            letterBtn.className = 'letter';
            letterBtn.textContent = letter;
            letterBtn.dataset.letterValue = letter; 
            letterBtn.dataset.originalIndex = index; 
            letterBtn.addEventListener('click', () => selectLetterForBuild(letter, letterBtn));
            elements.letterPool.appendChild(letterBtn);
        });
      }

      function clearBuild() {
          gameState.userBuiltWord = [];
          updateBuildWordDisplay();
          elements.feedback.textContent = '';
          
          elements.letterPool.querySelectorAll('.letter').forEach(button => {
              button.disabled = false;
              button.classList.remove('selected');
          });
      }

      function checkBuildWord() {
          if (gameState.userBuiltWord.join('') === gameState.targetBuildWord) {
              elements.feedback.textContent = `🎉 Correct! You built: ${gameState.targetBuildWord.toLowerCase()} ${gameState.correctEmoji}`; 
              
              elements.letterPool.querySelectorAll('.letter').forEach(btn => btn.disabled = true);
              elements.clearBuildBtn.disabled = true;
              elements.checkBuildBtn.disabled = true;

              setTimeout(() => {
                  setupBuildMode(); 
              }, 1800); 
          } else {
              elements.feedback.textContent = '❌ Not quite! Try again.';
          }
      }

      function endBuildGame(message) {
        elements.gameArea.classList.add('hidden');
        elements.gameComplete.classList.remove('hidden');
        elements.finalMessage.textContent = message; 
        
        let existingChooseAnotherPack = elements.gameComplete.querySelector('.choose-another-pack-btn');
        if (existingChooseAnotherPack) {
            existingChooseAnotherPack.remove();
        }

        elements.playAgainBtn.textContent = 'Play Build a Word Again';
        elements.playAgainBtn.onclick = () => startGame('build'); 

        const chooseAnotherGameBtn = document.createElement('button');
        chooseAnotherGameBtn.className = 'play-again choose-another-game-btn';
        chooseAnotherGameBtn.textContent = 'Choose Another Game';
        chooseAnotherGameBtn.onclick = () => goHome();
        elements.gameComplete.appendChild(chooseAnotherGameBtn);
      }


      function endGame(message) {
        elements.gameArea.classList.add('hidden');
        elements.gameComplete.classList.remove('hidden');
        elements.finalMessage.textContent = message;
        
        let existingChooseAnotherPack = elements.gameComplete.querySelector('.choose-another-pack-btn');
        if (existingChooseAnotherPack) {
            existingChooseAnotherPack.remove();
        }
        let existingChooseAnotherGame = elements.gameComplete.querySelector('.choose-another-game-btn');
        if (existingChooseAnotherGame) {
            existingChooseAnotherGame.remove();
        }

        elements.playAgainBtn.textContent = 'Play Again'; 
        elements.playAgainBtn.onclick = () => goHome(); 
      }
    });
  </script>
</body>
</html>
